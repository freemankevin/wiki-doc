---
title: 锁问题
description: PostgreSQL - 锁问题
published: true
date: 2026-01-30T03:22:32.375Z
tags: postgis, postgresql, dblink, uuid-ossp, pg_trgm, hstore, json/jsonb, pg_stat_statements, citext
editor: markdown
dateCreated: 2026-01-30T01:31:15.937Z
---

# 插件启用

> PostgreSQL 相关的 插件启用 问题收集
{.is-info}


---

## 1.PostGIS (地理信息系统)

**安装插件：**
```sql
CREATE EXTENSION postgis;
CREATE EXTENSION postgis_topology;
CREATE EXTENSION postgis_raster;
```


> 错误：`ERROR: could not open extension control file`
{.is-danger}


> 解决：确保已安装 postgis 系统包 `apt-get install postgresql-<version>-postgis`
{.is-success}

> 版本不兼容问题
{.is-danger}

> 检查：`SELECT postgis_version();`
{.is-success}


---

## 2.dblink (跨数据库连接)

**安装插件：**
```sql
CREATE EXTENSION dblink;
```

**基本用法：**
```sql
-- 连接其他数据库执行查询
SELECT * FROM dblink('dbname=otherdb host=localhost user=postgres password=xxx',
  'SELECT id, name FROM users') AS t(id int, name text);
```

> 错误：`permission denied for schema public`
{.is-danger}

> 解决办法：检查目标数据库的权限配置
{.is-success}


> 连接字符串格式错误
{.is-danger}

> 正确格式：`'dbname=xxx host=xxx user=xxx password=xxx'`
> {.is-warning}
{.is-success}



---

## 3.uuid-ossp (UUID 生成)

**安装插件：**
```sql
CREATE EXTENSION "uuid-ossp";
```

**基本用法：**
```sql
-- 生成 UUID v4
SELECT uuid_generate_v4();

-- 生成 UUID v1（基于时间戳）
SELECT uuid_generate_v1();

-- 作为默认值
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name VARCHAR(100)
);
```
> 插件名称需要带引号 `"uuid-ossp"`，不能是 `uuid_ossp`
{.is-warning}


---

## 4.pg_trgm (模糊查询和全文搜索)

**安装插件：**
```sql
CREATE EXTENSION pg_trgm;
```

**基本用法：**
```sql
-- 相似度查询
SELECT * FROM products WHERE name % 'iphone';

-- 创建 GIN 索引加速查询
CREATE INDEX idx_product_name_trgm ON products USING gin (name gin_trgm_ops);

-- 查看相似度分数
SELECT similarity('iphone', 'ipone');
```


> 查询结果不准确：调整相似度阈值 `SET pg_trgm.similarity_threshold = 0.3;`
{.is-warning}


---

## 5.hstore (键值对存储)

**安装插件：**
```sql
CREATE EXTENSION hstore;
```

**基本用法：**
```sql
-- 创建表
CREATE TABLE config (
  id SERIAL PRIMARY KEY,
  settings hstore
);

-- 插入数据
INSERT INTO config VALUES (1, 'color=>red,size=>large'::hstore);

-- 查询
SELECT settings->'color' FROM config;
SELECT akeys(settings) FROM config;
```

> 类型转换错误：确保用 `::hstore` 强制转换
{.is-warning}


---

## 6.JSON/JSONB (JSON 数据类型)

**内置无需安装，直接使用：**
```sql
-- JSONB 示例（推荐使用，性能更好）
CREATE TABLE api_responses (
  id SERIAL PRIMARY KEY,
  data JSONB
);

-- 插入 JSON 数据
INSERT INTO api_responses VALUES (1, '{"user": "john", "age": 30}'::jsonb);

-- 查询 JSON 字段
SELECT data->'user' FROM api_responses;
SELECT data->>'user' FROM api_responses;

-- 创建 GIN 索引加速查询
CREATE INDEX idx_api_responses_data ON api_responses USING gin (data);
```

---

## 7.pg_stat_statements (SQL 性能统计)

**安装插件：**
```sql
CREATE EXTENSION pg_stat_statements;
```

**查询慢 SQL：**
```sql
SELECT query, calls, mean_exec_time, max_exec_time 
FROM pg_stat_statements 
ORDER BY mean_exec_time DESC 
LIMIT 10;

-- 重置统计数据
SELECT pg_stat_statements_reset();
```

**配置（需要修改 postgresql.conf）：**
```
shared_preload_libraries = 'pg_stat_statements'
pg_stat_statements.track = all
```

---

## 8.citext (不区分大小写的文本)

**安装插件：**
```sql
CREATE EXTENSION citext;
```

**基本用法：**
```sql
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  email citext UNIQUE,
  username citext
);

-- 查询时不区分大小写
SELECT * FROM users WHERE email = 'JOHN@EXAMPLE.COM';
```

---

## 检查已安装的插件

```sql
-- 查看所有可用插件
SELECT * FROM pg_available_extensions;

-- 查看已安装的插件
SELECT * FROM pg_extension;

-- 查看插件中的对象
SELECT * FROM pg_extension WHERE extname = 'postgis';
```

---

## 常见问题

### 插件不存在
```
ERROR: extension "xxx" does not exist
```
- 检查：`SELECT * FROM pg_available_extensions WHERE name = 'xxx';`
- 解决：安装系统包或从源编译

### 权限不足
```
ERROR: permission denied for schema public
```
- 解决：赋予权限 `GRANT USAGE ON SCHEMA public TO user;`

### 卸载插件
```sql
-- 卸载前先删除依赖的对象
DROP EXTENSION postgis CASCADE;
```

---

[返回 PostgreSQL](/postgresql)
