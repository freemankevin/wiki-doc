---
title: 连接问题
description: PostgreSQL - 连接问题
published: true
date: 2026-01-30T03:33:41.471Z
tags: postgresql, 连接数
editor: markdown
dateCreated: 2026-01-30T01:30:59.975Z
---

# 连接问题
> PostgreSQL 相关的连接问题收集
{.is-info}

---

## 问题列表

### 1. PostgreSQL 最大连接数不足

**问题描述：** 连接数超过 PostgreSQL 默认的最大连接数限制（默认100），导致新连接无法建立。

**错误信息：**
```
FATAL: too many connections for role "username"
FATAL: remaining connection slots are reserved for non-replication superuser connections
```

---

## 解决方案

### 方案一：修改配置文件（PG版本 >= 13）

#### 1. 找到配置文件位置
```shell
# 查找 postgresql.conf 文件位置
sudo -u postgres psql -c "SHOW config_file"
```

#### 2. 编辑配置文件
```shell
# 通常位置：
# Linux: /var/lib/pgsql/data/postgresql.conf
# Docker: /var/lib/postgresql/data/postgresql.conf

sudo vim /var/lib/postgresql/data/postgresql.conf
```

#### 3. 修改连接数参数
```ini
# 查找并修改以下参数
max_connections = 200

# 同时修改相关参数（可选）
superuser_reserved_connections = 3
```

#### 4. 重启 PostgreSQL
```shell
# 原生安装
sudo systemctl restart postgresql

# Docker 容器
docker restart <container_id>
```

#### 5. 验证修改
```sql
SHOW max_connections;
```

---

### 方案二：SQL 命令修改（推荐用于 PG < 13 版本）

> 对于 PG 版本小于 13 的版本，修改配置文件可能无效，需要使用 SQL 命令强制修改。
{.is-warning}


#### 1. 执行 ALTER SYSTEM 命令
```sql
ALTER SYSTEM SET max_connections = '200';
```

#### 2. 重新加载配置
```sql
SELECT pg_reload_conf();
```

#### 3. 重启 PostgreSQL 容器
```shell
# 如果是 Docker 环境
docker restart <container_id>

# 如果是本地安装
sudo systemctl restart postgresql
```

#### 4. 验证修改
```sql
SHOW max_connections;
```

---

### 方案三：Docker 环境修改

#### 方法 1：通过命令行参数
```shell
docker run -d \
  --name postgres \
  -e POSTGRES_PASSWORD=password \
  -c max_connections=200 \
  postgres:13
```

#### 方法 2：通过 docker-compose
```yaml
version: '3.8'
services:
  postgres:
    image: postgres:13
    environment:
      POSTGRES_PASSWORD: password
    command:
      - "postgres"
      - "-c"
      - "max_connections=200"
    ports:
      - "5432:5432"
```

#### 方法 3：进入容器修改
```bash
# 进入容器
docker exec -it <container_id> bash

# 连接数据库
psql -U postgres

# 执行修改命令
ALTER SYSTEM SET max_connections = '200';
SELECT pg_reload_conf();

# 重启容器
docker restart <container_id>
```
---

## 重要参数说明

| 参数 | 默认值 | 说明 |
|------|-------|------|
| `max_connections` | 100 | 最大连接数 |
| `superuser_reserved_connections` | 3 | 为超级用户保留的连接数 |
| `shared_buffers` | 25% 内存 | 共享缓冲区（建议为内存的 25%）|
| `work_mem` | 4MB | 工作内存（建议根据 max_connections 调整） |

### 内存计算建议
```
所需内存 ≈ shared_buffers + (max_connections × work_mem)

示例：
- shared_buffers = 2GB
- max_connections = 200
- work_mem = 10MB
- 所需总内存 ≈ 2GB + (200 × 10MB) = 4GB
```
---

## 相关命令速查

```sql
-- 查看当前所有配置参数
SHOW all;

-- 查看特定参数
SHOW max_connections;

-- 修改参数（session 级别，重启后失效）
SET max_connections = 200;

-- 修改参数（永久，需要重启）
ALTER SYSTEM SET max_connections = '200';

-- 重新加载配置文件
SELECT pg_reload_conf();

-- 查看活跃连接数
SELECT count(*) FROM pg_stat_activity;

-- 查看连接详情
SELECT datname, usename, count(*) FROM pg_stat_activity GROUP BY datname, usename;
```

---

[返回 PostgreSQL](/postgresql)